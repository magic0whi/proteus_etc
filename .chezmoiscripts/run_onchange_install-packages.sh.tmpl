{{ if eq .chezmoi.os "linux" -}}
{{- if eq .chezmoi.osRelease.name "Arch Linux" -}}
#!/bin/sh
set -eufo pipefail
# Install common and host specific packages
pacman -Syu --needed --noconfirm
{{- range .COMMON.packages.arch }}{{ print " " . }}{{ end }}
{{- range index . .chezmoi.hostname "packagesSpec" }}{{ print " " . }}{{ end }}

# Install Extra Packages
{{- if index . .chezmoi.hostname "installExtra" }}
pacman -S --needed --noconfirm{{ range .COMMON.packages.archExtra }}{{ print " " . }}{{ end }}
{{- end }}
{{- if index . .chezmoi.hostname "packagesAUR" }}

# Install AUR packages
RAMDISK_SIZE=$(($(free -m | awk '/Mem/ { print $7 }')/2))
mount --mkdir -t tmpfs -o defaults,size=${RAMDISK_SIZE}M tmpfs {{ .COMMON.aurChrootPath }}

trap 'umount {{ .COMMON.aurChrootPath }}/overlay {{ .COMMON.aurChrootPath }}; rm /etc/sudoers.d/03_aur_tmp' EXIT

dd if=/dev/zero of={{ .COMMON.aurChrootPath }}/ramdisk status=progress bs=1M count=$RAMDISK_SIZE
mkfs.btrfs -m single -f {{ .COMMON.aurChrootPath }}/ramdisk
mount --mkdir -t btrfs -o loop,compress=zstd {{ .COMMON.aurChrootPath }}/ramdisk {{ .COMMON.aurChrootPath }}/overlay
chown {{ .COMMON.mainUser }}: {{ .COMMON.aurChrootPath }}/overlay

sudo -u {{ .COMMON.mainUser }} paru -S --needed --noconfirm --chroot={{ .COMMON.aurChrootPath }}/overlay{{ range index . .chezmoi.hostname "packagesAUR" }}{{ print " " . }}{{ end }}
{{- end }}
{{- end }}
{{- end -}}
